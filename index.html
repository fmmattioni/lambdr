<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create a Runtime for Serving Containerised R Functions on AWS Lambda • lambdr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Create a Runtime for Serving Containerised R Functions on AWS Lambda">
<meta property="og:description" content="Runtime for serving containers that can execute R code on the 
    AWS Lambda serverless compute service &lt;\https://aws.amazon.com/lambda/&gt;.
    Provides the necessary functionality for handling the various endpoints
    required for accepting new input and sending responses.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">lambdr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/api-gateway-invocations.html">API Gateway Invocations</a>
    </li>
    <li>
      <a href="articles/lambda-runtime-in-container.html">Placing an R Lambda Runtime in a Container</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mdneuzerling/lambdr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="lambdr" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#lambdr" class="anchor"></a>lambdr</h1></div>
<!-- badges: start -->

<p>Running R containers on AWS Lambda.</p>
<p>This package is in active development, and is not yet ready for use.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"mdneuzerling/lambdr"</span><span class="op">)</span></code></pre></div>
</div>
<div id="running" class="section level2">
<h2 class="hasAnchor">
<a href="#running" class="anchor"></a>Running</h2>
<p>In a <code>runtime.R</code> file, source all functions needed and then run:</p>
<pre class="{r}"><code><a href="reference/start_lambda.html">lambdr::start_lambda()</a></code></pre>
<p>This <code>runtime.R</code> file should be executed by the Docker image containing your Lambda code.</p>
<p>The <code><a href="reference/start_lambda.html">lambdr::start_lambda()</a></code> function relies on environment variables configured by AWS. It will fail if run locally. In particular, the <em>handler</em> as configured by the user through AWS will determine which function handles the Lambda events. For debugging and testing, values can be provided to the function in the absence of environment variables. See <code><a href="reference/start_lambda.html">?lambdr::start_lambda</a></code> for details.</p>
</div>
<div id="example" class="section level2">
<h2 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h2>
<p>Consider the following <code>runtime.R</code> file:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">parity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>parity <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">number</span><span class="op">)</span> <span class="op">%%</span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="st">"even"</span> <span class="kw">else</span> <span class="st">"odd"</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">lambdr</span><span class="fu">::</span><span class="fu"><a href="reference/start_lambda.html">start_lambda</a></span><span class="op">(</span>log_threshold <span class="op">=</span> <span class="fu">logger</span><span class="fu">::</span><span class="va"><a href="https://daroczig.github.io/logger/reference/log_levels.html">DEBUG</a></span><span class="op">)</span></code></pre></div>
<p>The <code>parity</code> function accepts a <code>number</code> argument and returns its parity as a named list, for example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">parity</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co"># $parity</span>
<span class="co"># [1] "odd"</span>


<span class="fu">parity</span><span class="op">(</span><span class="fl">8</span><span class="op">)</span>
<span class="co"># $parity</span>
<span class="co"># [1] "even"</span></code></pre></div>
<p>This function can then be placed into a Docker image. An <strong>example</strong> is provided below, but the key components are:</p>
<ul>
<li>Start from the <code>public.ecr.aws/lambda/provided</code> parent image, which provides the basic components necessary to serve a Lambda</li>
<li>Install R and dependencies, both system dependencies and R packages, including the <code>lambdr</code> package</li>
<li>Copy across <code>runtime.R</code> and any other necessary files</li>
<li>Generate a simple bootstrap which runs <code>runtime.R</code> with R</li>
<li>Set the handler as the <code>CMD</code>. The <code>lambdr</code> package interprets the handler as the name of the function to use, in this case, “parity”. The <code>CMD</code> can also be set (or overriden) when setting up the Lambda in AWS.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">FROM</span> public.ecr.aws/lambda/provided</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">ENV</span> R_VERSION=4.0.3</a>
<a class="sourceLine" id="cb5-4" title="4"></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="kw">RUN</span> yum -y install wget git tar</a>
<a class="sourceLine" id="cb5-6" title="6"></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="kw">RUN</span> yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm \</a>
<a class="sourceLine" id="cb5-8" title="8">  &amp;&amp; wget https://cdn.rstudio.com/r/centos-7/pkgs/R-${R_VERSION}-1-1.x86_64.rpm \</a>
<a class="sourceLine" id="cb5-9" title="9">  &amp;&amp; yum -y install R-${R_VERSION}-1-1.x86_64.rpm \</a>
<a class="sourceLine" id="cb5-10" title="10">  &amp;&amp; rm R-${R_VERSION}-1-1.x86_64.rpm</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="kw">ENV</span> PATH=<span class="st">"${PATH}:/opt/R/${R_VERSION}/bin/"</span></a>
<a class="sourceLine" id="cb5-13" title="13"></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co"># System requirements for R packages</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="kw">RUN</span> yum -y install openssl-devel</a>
<a class="sourceLine" id="cb5-16" title="16"></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="kw">RUN</span> Rscript -e <span class="st">"install.packages(c('httr', 'jsonlite', 'logger', 'remotes'), repos = 'https://packagemanager.rstudio.com/all/__linux__/centos7/latest')"</span></a>
<a class="sourceLine" id="cb5-18" title="18"><span class="kw">RUN</span> Rscript -e <span class="st">"remotes::install_github('mdneuzerling/lambdr')"</span></a>
<a class="sourceLine" id="cb5-19" title="19"></a>
<a class="sourceLine" id="cb5-20" title="20"><span class="kw">RUN</span> mkdir /lambda</a>
<a class="sourceLine" id="cb5-21" title="21"><span class="kw">COPY</span> runtime.R /lambda</a>
<a class="sourceLine" id="cb5-22" title="22"><span class="kw">RUN</span> chmod 755 -R /lambda</a>
<a class="sourceLine" id="cb5-23" title="23"></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="kw">RUN</span> printf <span class="st">'#!/bin/sh\ncd /lambda\nRscript runtime.R'</span> &gt; /var/runtime/bootstrap \</a>
<a class="sourceLine" id="cb5-25" title="25">  &amp;&amp; chmod +x /var/runtime/bootstrap</a>
<a class="sourceLine" id="cb5-26" title="26"></a>
<a class="sourceLine" id="cb5-27" title="27"><span class="kw">CMD</span> [<span class="st">"parity"</span>]</a></code></pre></div>
<p>The image is built and uploaded to AWS Elastic Container Registry (ECR). First, a repository is created:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1"><span class="ex">aws</span> ecr create-repository --repository-name parity-lambda --image-scanning-configuration scanOnPush=true</a></code></pre></div>
<p>This provides a URI, the resource identifier of the created repository. The image can now be pushed:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="ex">docker</span> tag mdneuzerling/r-on-lambda:latest <span class="dt">{URI}</span>/parity-lambda:latest</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="ex">aws</span> ecr get-login-password <span class="kw">|</span> <span class="ex">docker</span> login --username AWS --password-stdin <span class="dt">{URI}</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="ex">docker</span> push <span class="dt">{URI}</span>/parity-lambda:latest</a></code></pre></div>
<p>In either the AWS console or the command line, a Lambda can be created from this image. Call the Lambda “parity” to match the function name. Tests can be executed within the console. Alternatively the Lambda can be invoked from the CLI:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="ex">aws</span> lambda invoke --function-name parity \</a>
<a class="sourceLine" id="cb8-2" title="2">  --invocation-type RequestResponse --payload <span class="st">'{"number": 8}'</span> \</a>
<a class="sourceLine" id="cb8-3" title="3">  /tmp/response.json --cli-binary-format raw-in-base64-out</a></code></pre></div>
<p>The output is now available in the generated file:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">cat</span> /tmp/response.json            </a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="dt">{"parity":"even"}</span></a></code></pre></div>
</div>
<div id="package-structure-and-operating-method" class="section level2">
<h2 class="hasAnchor">
<a href="#package-structure-and-operating-method" class="anchor"></a>Package structure and operating method</h2>
<div id="runtime-endpoints" class="section level3">
<h3 class="hasAnchor">
<a href="#runtime-endpoints" class="anchor"></a>Runtime endpoints</h3>
<p>The runtime works by querying HTTP endpoints configured by AWS Lambda. These endpoints are configured based on the “AWS_LAMBDA_RUNTIME_API” environment variable set by AWS Lambda during initialisation. They generally won’t be available locally.</p>
<ul>
<li>The <strong>next invocation endpoint</strong> is the endpoint which R must query for the next input. R must send a <code>GET</code> request to this endpoint and will wait until either a response is received or the Lambda instance is shut down for inactivity. When Lambda receives an input from, say, an API Gateway, it will respond to the pending request with details of the input. We call the response to this request an <em>invocation</em> in this document, and invocations are interpreted as <em>events</em>.</li>
<li>The <strong>initialisation error endpoint</strong> is where an error should be sent if the error occurs when setting up the runtime. This is distinct from errors that occur during handling of an event.</li>
<li>The <strong>response endpoint</strong> is where an event response should be sent. It is unique for each event.</li>
<li>The <strong>invocation error endpoint</strong> is where errors that occur during event handling should be reported. It is unique for each event.</li>
</ul>
<p>The next invocation and initialisation error endpoints are unique in each Lambda instance. The response and invocation error endpoints are determined by the <code>request_id</code> associated with each invocation. The request ID is given in the “lambda-runtime-aws-request-id” header in the response to the query of the next invocation endpoint.</p>
</div>
<div id="handler-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#handler-functions" class="anchor"></a>Handler functions</h3>
<p>Every Lambda instance is centred around a single function which handles any inputs. The <em>handler function</em> is determined by an environment variable which can be configured in one of two ways:</p>
<ul>
<li>as the <code>CMD</code> to the Dockerfile which contains the runtime, or</li>
<li>as configured through the Lambda console (this takes precedence)</li>
</ul>
<p>The <code>setup_lambda</code> function (run as part of <code>start_lambda</code>) picks up on this environment variable and identifies the function to which it refers. This handler function is used to process all invocations.</p>
</div>
</div>
<div id="event-listening-lifecycle" class="section level2">
<h2 class="hasAnchor">
<a href="#event-listening-lifecycle" class="anchor"></a>Event listening lifecycle</h2>
<p>The main function, <code>start_lambda</code>, runs three functions in sequence:</p>
<ul>
<li><code>setup_logging</code></li>
<li><code>setup_lambda</code></li>
<li><code>start_listening</code></li>
</ul>
<p>The <code>start_listening</code> function sets up an infinite loop that listens for <em>invocations</em>, interprets them as <em>events</em>, and processes them with the handler function.</p>
<p>Events need to be handled differently depending upon whether they are invoked directly, by an API Gateway, etc. Events are classified according to their detected invocation method, with their invocation stored as an S3 class. The following functions dispatch on this class:</p>
<ul>
<li>
<code>parse_event_content</code> converts the raw event content into arguments to be passed to the handler function</li>
<li>
<code>seralise_result</code> converts the result into the form that will be sent back to Lambda</li>
<li>
<code>handle_event_error</code> deals with errors that occur during event handling. Some invocation types require errors to be formatted or handled in a very specific way.</li>
</ul>
<p><code>start_listening</code> triggers the listening loop, which consists of <code>wait_for_event</code> and <code>handle_event</code> (combined into <code>wait_for_and_handle_event</code>). Once a response (called an <em>invocation</em>) is sent to the request made in <code>wait_for_event</code>, it is <em>decomposed</em> into and classified into an <em>event</em>. If an error occurs during this stage it is handled by <code>handle_decomposition_error</code>. If possible the error will be posted to the error invocation endpoint so that Lambda can process it, but otherwise it will simply be logged and then the</p>
<p>The event is passed to <code>handle_event</code> which consists of the following steps:</p>
<ul>
<li>
<code>parse_event_content</code> interprets the event content as arguments to be handed to the handler function. The user can also provide a function to the <code>deseraliser</code> argument of <code>start_listening</code> (or <code>start_lambda</code>), which will override the standard parsing logic.</li>
<li>
<code>generate_result</code> passes these arguments to the handler function and generates a result.</li>
<li>
<code>seralise_result</code> converts the result into the response that will be sent to Lambda. The user can also provide a function to the <code>serialiser</code> argument of <code>start_listening</code> (or <code>start_lambda</code>), which will override the standard serialisation logic.</li>
<li>
<code>post_result</code> posts the serialised result to the response endpoint.</li>
</ul>
<p>Afterwards, the runtime will return to the <code>wait_for_event</code> function and process the next invocation that arrives. AWS Lambda may shut down the instance if it times out before another event invocation arrives.</p>
<p>Alternatively, if an error occurs during <code>wait_for_event</code> it will be handled by <code>handle_decomposition_error</code>, or if it occurs during <code>handle_event</code> it will be dispatched to the appropriate <code>handle_event_error</code> method according to the S3 class of the event. In either case this will not stop the R session — an error when processing a single event is a problem for that event alone. The runtime will return to the <code>wait_for_event</code> step.</p>
<p>All of these functions are diagrammed below, with boxes representing functions which are grouped together according to the primary function that calls each of them in sequence. Errors are shown in red.</p>
<p><img src="reference/figures/start-listening.drawio.svg" align="center" height="800"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/mdneuzerling/lambdr/">https://​github.com/​mdneuzerling/​lambdr/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/mdneuzerling/lambdr/issues">https://​github.com/​mdneuzerling/​lambdr/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>David Neuzerling <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=lambdr"><img src="https://www.r-pkg.org/badges/version/lambdr" alt="CRAN status"></a></li>
<li><a href="https://cran.r-project.org/package=lambdr"><img src="https://cranlogs.r-pkg.org/badges/lambdr" alt="CRAN downloads"></a></li>
<li><a href="https://github.com/mdneuzerling/lambdr/tree/main"><img src="https://img.shields.io/github/last-commit/mdneuzerling/lambdr/main.svg" alt="Last commit"></a></li>
<li><a href="https://github.com/mdneuzerling/lambdr/actions"><img src="https://github.com/mdneuzerling/lambdr/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://codecov.io/gh/mdneuzerling/lambdr?branch=main"><img src="https://codecov.io/gh/mdneuzerling/lambdr/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://choosealicense.com/licenses/mit/"><img src="https://img.shields.io/badge/license-MIT-lightgrey.svg" alt="license"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by David Neuzerling.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
